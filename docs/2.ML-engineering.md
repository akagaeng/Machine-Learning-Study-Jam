# 2. ML Engineering

## 프로덕션 ML 시스템

> 머신러닝에는 단순한 ML 알고리즘 구현 외에 훨씬 더 많은 것이 포함되어 있습니다. 프로덕션 ML 시스템에는 많은 구성요소가 포함됩니다.

- ex) 데이터 수집, 피쳐 추출, 프로세스 관리, 데이터 확인, 머신 리소스 관리, 분석, 모니터링, 서빙 인스트럭쳐 등
- 모든 구성요소를 직접 만들 필요는 없다.

## ML 시스템 패러다임: 학습(정적 학습과 동적 학습 비교)

> 모델을 학습시키는 방법은 보통 두가지로 구분한다.

- 정적 모델
  + 오프라인으로 학습한다.
  + 모델을 한번만 학습시키고, 해당 모델을 일정 기간 사용한다.
  + 시간이 지나도 데이터에 큰 변화가 없는 경우에 유용
  + 장점
    * 손쉬운 빌드 및 테스트
    * batch 할당량만 사용하면 되므로 비용이 적게 든다.
    * 모델이 만족스러울 때까지 반복할 수 있다.
    * 서비스 전에 제대로 작동하는지 확인 가능
  + 단점
    * 추론시 입력 레벨에서 계속 모니터링해야 한다,
    * 업데이트가 어려워 노후화되기 쉬우며 생산성이 떨어진다.
- 동적 모델
  + 온라인으로 학습한다.
  + 데이터가 시스템에 계속 유입되며, 지속적인 업데이트를 통해 해당 데이터를 모델에 통합한다.
  + 시간이 지나면서 자주 변경되는 데이터인 경우에 최신 상태를 유지하려할 때 적합하다.
  + 장점
    * 생산성 저하가 발생하지 않는다.
  + 단점
    * 정적 모델 학습보다 모니터링의 부담 훨씬 더 크다.
    * 따라서 더 복잡한 시스템과 모니터링 기능 필요하다.

## 정적 추론과 동적 추론 비교

> 머신러닝 시스템 설계시 선택할 수 있는 추론(예측) 전략은 오프라인 추론, 온라인 추론 두 가지가 있습니다.

- 오프라인 추론
  + MapReduce 등을 사용하여 가능한 모든 예측을 일괄적으로 생성합니다. 그런 다음 예측을 SSTable 또는 Bigtable에 기록하고 캐시/조회 테이블에 입력합니다.
  + 장점
    * 오프라인 점수 산영하여 예측 후 유효성 검사를 할 수 있어 유용함
    * 점수를 기록한 다음 실제로 적용하기 전에 점수가 합당한지 정상성 체크를 할 수 있다.
    * 계산 비용이 크게 문제되지 않는다. (머신을 몇 개 더 사용하거나 배치할당량 또는 초대형 맵 제품을 사용할 수 있다.)
  + 단점
    * 예측할 때 모든 예제를 보유하고 있어야 한다.
    * 후속 내용이 많거나 엄청난 분포 때문에 내용이 계속 변경되는 영역에서 문제될 수 있다.
- 온라인 추론
  + 서버에 저장된 모델을 사용하여 주문형으로 계속 예측한 다음 새로운 요청시 새로운 데이터를 예측합니다.
  + 장점
    * 후속 내용이 많거나 엄청난 분포 때문에 내용이 계속 변경되는 영역에서도 주문형으로 계속 예측을 얻을 수 있다.
  + 단점
    * 예측을 얻는 데 지연문제가 발생한다.
    * 모델 계산 비용이 비싼 경우 작업에서 상당량의 프로덕션 레벨 리소스가 필요할 수 있고, 비용이 많이 들어간다.
    * 서비스작업에 대한 모니터링 및 예측 결과 배포 등 다른 작업에 대해서도 모니터링해야 한다.


## 프로덕션 ML 시스템: 데이터 종속성

### 기존 개발 vs ML 개발
- ML 개발자에게 데이터는 기존 개발자에게 코드와 같이 중요
- 기존 소프트웨어 개발 프로젝트에서는 유닛 테스트를 작성하여 코드의 유효성을 확인하는 것이 좋듯이 ML 프로젝트에서는 지속적으로 입력 데이터를 테스트하고 유효성을 확인하고 데이터를 모니터링해야 한다.
- 예를 들면 모델을 지속적으로 모니터링하여 (거의) 사용하지 않는 특성을 삭제해야 한다.

### 신뢰성
- 입력 데이터의 신뢰성
  + 신호 데이터가 들어오는 경우 신호를 항상 사용할 수 있는지, 또는 신호가 안정적이지 않은 출처에서 제공되는지 등을 고려해야 한다.

### 버전 차별화
데이터가 버전에 따라서 다르게 들어올 수도 있는지 고려해야 한다.

### 필요성
새로운 기능을 추가할 때는 투자 대비 효과가 충분하여 장기적인 시스템 유지보수 비용에 무리가 없는지 살펴봐야 한다.

### 상관성
일부 특성은 다른 특성과 양의 또는 음의 상관관계를 가진다. 이런 상관관계도 고려해야 한다.

### 피드백 루프
- 시스템에 비정상성이 없어야 한다.
- 어떤 입력 신호가 모델의 출력에 영향을 받을 수 있는지?

모델이 자체 학습 데이터에 영향을 미칠 수 있는 경우도 있습니다(`비정상성이 있는 경우`). 예를 들면 일부 모델에서는 출력 결과값이 직간접적으로 그 모델의 입력 값이 되기도 합니다. 이로써 모델 A, 모델 B 서로 악영향을 끼칠 수 있다.

## 이해도 평가
## 다음 중 피드백 루프에 취약한 모델은?
- 해변의 인파를 특성 중 하나로 사용하여 해변 근처 고속도로 출구의 정체를 예측하는 교통량 예측 모델
- 경쟁률(즉, 대학에 지원한 학생 중 합격자의 비율)을 기준으로 부분적으로 학교를 평가하는 대학 순위 평가 모델
- 인기도(즉, 책 구매 횟수)를 바탕으로 사용자가 좋아할 만한 소설을 추천하는 도서 추천 모델

> 즉, 비정상성(어떤 입력이 다른 모델의 출력에 영향을 끼칠 수 있음)이 있을 수 있는 모델이 피드백 루프에 취약하다고 할 수 있다.

